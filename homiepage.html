<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
      
      <link rel = "stylesheet" href = "css/homiepage.css" type="text/css">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
	
	<title>Homepage Generator 5000</title>
  </head>
  <body>
    <!-- Step one: enter user id -->
    <div id = "id">
        <div class = "form-group col-sm-11">
            <label for = "idBox">Enter your ID</label>
            <input type = "text" class = "form-control" id = "idBox" placeholder = "Be sure to remember what you put here"/>
        </div>
        <br/>
        <button type = "button" id = "idButton" class = "btn btn-default">
            OK
            <span class = "glyphicon glyphicon-ok"></span>
        </button>
    </div>
    <!-- Step two: enter category -->
    <!-- Step 3: Add sites for that category -->
    <div id = "form">
        
    </div>
    <!-- Step 4: Acquire custom homepage -->
    <div id = "result">
      
    </div>
	
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
     
      <!-- firebase library -->
		<script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
      
    <!-- Actual script -->
      <script type = "text/javascript">
        $(document).ready(function() {
            //get id
            var uuid;
            //user child
            var user;
            //category child
            var feline;
            //database root
            var homepageDB = new Firebase("https://homiepages.firebaseio.com/");
            //get and handle the button for submitting user id
            var idButton = document.querySelector("#idButton");
            idButton.addEventListener("click", idFunc, false);
            function idFunc() {
                //grab the user's id
                uuid = document.querySelector("#idBox").value;
                homepageDB.once("value", function(snapshot) {
                    //check and see if this user exists
                    var found = false;
                    var loops = 0;
                    snapshot.forEach(function(childSS) {
                        if(childSS.key() === uuid) {
                            found = true;
                        }
                        loops++;
                    })
                    //if this is a new user, add them in
                    if(found === false && loops > 0) {
                        homepageDB.child(uuid).set("");
                    }
                    //set the 'user' variable for easy access to its children and move on to the next step
                    user = homepageDB.child(uuid);
                    formFiller(user);
                })
            }
            //set a variable for quick access to the 'form' div
            var formZone = document.querySelector("#form");
            function formFiller(userPage) {
                //clear the id input div, we're done with that
                document.querySelector("#id").innerHTML = "";
                formZone.innerHTML += "<!-- Bush did 9/11 -->";
                //have the user enter a category
                formZone.innerHTML += "<div class = 'col-sm-11'><label for='cat1' >Enter a category: </label><input type='text' class='form-control' id='cat1' placeholder='Category'/></div><div class = 'col-sm-1'><br/><button type = 'button' id = 'catButt' class = 'btn btn-default'> Submit <span class = 'glyphicon glyphicon-refresh'></span></button></div>";
                //get the category when they hit the submit button
                var catButt = document.querySelector("#catButt");
                catButt.addEventListener("click", catButtPressed, false);
            }
            function catButtPressed() {
                //make a variable for this category
                var kittyGory = document.querySelector("#cat1").value;
                console.log(kittyGory);
                //make a header so the user remembers what category they're dealing with
                formZone.innerHTML = "<h1>" + kittyGory + "</h1>";
                user.once("value", function(snapshot) {
                    //check to see if this category exists yet
                    var found = false;
                    snapshot.forEach(function(childSS) {
                        if(childSS.key() === kittyGory) {
                            found = true;
                        }
                    })
                    //if it doesn't exist yet, add it
                    if(found === false) {
                        user.child(kittyGory).set("");
                    }
                })
                //Tell the user what sites they already have
                formZone.innerHTML += "<div class = 'col-sm-12'><h3>Existing sites for this category:</h3></div>";
                feline = user.child(kittyGory);
                feline.once("value", function(snapshot) {
                    snapshot.forEach(function(childSS) {
                        console.log(childSS.val());
                        if(childSS.val() === "") {
                            feline.child(childSS.key()).remove;
                        }
                        else {
                        formZone.innerHTML += "<div class = 'col-sm-4 link'><a href = '" + childSS.val() + "'><h4>" + childSS.key() + "</h4></a></div>";
                        }
                    })
                    //Tell the user to enter sites
                    formZone.innerHTML += "<div class = 'col-sm-12'><h4><label for='site1' >Enter the names and urls for a few sites in this category: </label></h4></div>";
                    //loop to make the text boxes
                    for(var i = 1; i <= 3; i++) {
                        formZone.innerHTML += "<div class = 'col-sm-6'><input type='text' class='form-control' id='site" + i +"' placeholder='Site name'/></div><div class = 'col-sm-6'><input type='text' class='form-control' id='link" + i + "' placeholder = 'url'/></div>"
                    }
                    //make the submit button
                    formZone.innerHTML += "<div class = 'col-sm-12'><button type = 'button' id = 'addSites' class = 'btn btn-default'>Add Sites <span class = 'glyphicon glyphicon-floppy-disk'></span></button></div>"
                    addSites.addEventListener("click", addSite, false);
                })
            }
            //take in "form" info
            function addSite() {
                var currentSite;
                var currentUrl;
                for(var i = 1; i <= 3; i++) {
                    if(document.querySelector("#site" + i).value !== "") {
                        currentSite = document.querySelector("#site" + i).value;
                        currentUrl = document.querySelector("#link" + i).value;
                        feline.child(currentSite).set(currentUrl);
                    }
                }
                //serve the page
                formZone.innerHTML = "";
                var siteZone = document.querySelector("#result");
                user.once("value", function(snapshot) {
                    var catnum = 1;
                    var catdiv;
                    //loop through the categories, making a div for each one
                    snapshot.forEach(function(childSS) {
                        siteZone.innerHTML += "<div class = 'col-sm-3 catcol' id = 'category" + catnum + "'></div>";
                        catdiv = document.querySelector("#category" + catnum);
                        catdiv.innerHTML += "<h3>" + childSS.key() + "</h3>";
                        catdiv.innerHTML += "<ul id = 'catlist" + catnum + "'></ul>"
                        var listdiv = document.querySelector("#catlist" + catnum);
                        //loop through the sites in each category, listing them in that category's div
                        childSS.forEach(function(grandchild) {
                            listdiv.innerHTML += "<li class = 'linkedList'><a href = '" + grandchild.val() + "'>" + grandchild.key() + "</a></li>";
                        });
                        catnum++;
                    });
                });
                //change the page title
                var title = document.querySelector("title");
                title.innerHTML = uuid + "'s Awesome Homepage";
            }
            
        })
      </script>
  </body>
</html>